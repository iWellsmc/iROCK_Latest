{% extends "base.html" %}
{% load widget_tweaks %}
{% load static %}
{% block content %}
{% load custom_tags %}

<link rel="stylesheet" type="text/css" href="{% static 'assets/css/master/vendorcontract.css' %}">
<div>
    <div class="row">
        <div class="col-12 text-end">
            <button type="button" class="btn btn-clr chck-tst"><a href="{% url 'projects:contract_detailed_view' contractmaster.id%}">Back</a></button>
        </div>
    </div>
<div class="row justify-content-center">
    <h3 class="from-head col-12">Add Amendment/Addendum</h3>
    <input type='hidden' id='user_role' value='{{request.user.roles_id}}'>

    <form class="form-txt col-lg-5 d-flex flex-column gap-4"  method="POST" id="editcontractmaster"  enctype="multipart/form-data" >
        {% csrf_token %}
        <select name="companycurrenices" id="id_companycurrenices" style="display:none">
            {% for country in companycurrency%}
            <option value="{{country.id}}">{{country.currency_symbol}}-{{country.currency}} ({{country.name}})</option>
            {% endfor %}
        </select>

        
        <select name="projects" id="id_projects" style="display:none">
            {% for project in projects%}
            <option value="{{project.id}}" data-id="{{project.active_status}}">{{project.projectname.name}}</option>
            {% endfor %}
        </select>

        <div class="row align-items-center">
            <div class="col-6">
                <input type="hidden" name="dateformat" id="companydateformat" value={{company.dateformat}}>
                <div><strong class="big-text">Vendor Name :</strong class="big-text"></div>
                
            </div>
            <div class="col-6">
                {{contractmaster.contractvendor.vendor_name}}
            </div>
        </div>

        <div class="row align-items-center">
            <div class="col-6">
                <div><strong class="big-text">Project Name :</strong class="big-text"></div>
                
            </div>
            <div class="col-6">
                <input type="hidden" value="{{contractmaster.projects.id}}" class="projectcls">
                {{contractmaster.projects.projectname.name}}
            </div>

        </div>

        <div class="row align-items-center">
            <div class="col-6">
                <div><strong class="big-text">Project Discipline	:</strong class="big-text"></div>
                
            </div>
            <div class="col-6">
                {{contractmaster.projectdiscipline|convert_projectdiscipline}}
            </div>

        </div>

        <div class="row align-items-center">
            <div class="col-6">
                <div><strong class="big-text">Discipline Type	:</strong class="big-text"></div>
                
            </div>
            <div class="col-6">
                {{contractmaster.projectdisciplinetype.discipline_subtype}}
            </div>
        </div>

        <div class="row align-items-center">
          <div class="col-6">
              <div><strong class="big-text">{% if contractmaster.types_service == 'service' %}Service{% elif contractmaster.types_service == 'supply' %}Supply{% else %}Service & Supply{% endif %} Name	:</strong class="big-text"></div>
              
          </div>
          <div class="col-6">
              {{contractmaster.name_service}}
          </div>
        </div>

        <div class="row align-items-center">
            <div class="col-6">
                <div><strong class="big-text">Contract Reference Number :</strong class="big-text"></div>
                
            </div>
            <div class="col-6">
              
              {{contractmaster.reference_number}}
          </div>
  

      </div>
        <div id="amendment_table" class="amendmenttablecls">
    <div class="row">

        <div class="col-6">
           <strong class="big-text"> Type</strong class="big-text">
        </div>
        <div class="col-6">
            <select name="ammendment_type" class="form-control ammendment_type">
                <option value="">--Select--</option>
                {%for type in types %}
                    <option value="{{type}}">{{type}}</option>
                {% endfor %}
            </select> 
        </div>

        
    </div>
    <br>
    <div class="row wcc_row">

        <div class="col-6">
            <strong class="big-text"> WCC <i class="fa fa-info-circle" title="Work Completion Certificate Submission Required"></i></strong class="big-text">
        </div>
        <div class="col-6">
            <input type="checkbox" class="wcc-cbx amend_wcc_flow_cls" value="0" name="wcc" >
        </div>

        
    </div>
    <br>
    <div class="row">

        <div class="col-6">
            <strong class="big-text">
            Reference Number
            </strong class="big-text">
        </div>
        <div class="col-6">
            <textarea rows="3" cols="30" name="ref_num" class="form-control ref_num"></textarea>
        </div>

        
    </div>
    <br>
    <div class="row">

        <div class="col-6">
            <strong class="big-text">
            Executed Date
            </strong class="big-text">
        </div>
        <div class="col-6">
            <input type=hidden name="min_date" value='{{ contractmaster.executed_date }}' class="dateformat-cls form-control" >
            <input type="text" name="dateformat" autocomplete="off" value="" class="dateformat-cls form-control" >
        </div>

        
    </div>
    <br>
    <div class="row">

        <div class="col-6">
            <strong class="big-text">
            Maximum Value
            </strong class="big-text">
        </div>
        <div class="col-6">
            <select name="currency" class="form-control">
                <option value='' selected>--Select--</option>
                {% for country in companycurrency %}
                <option  value="{{country.id}}">{{country.currency_symbol}}-{{country.currency}} ({{country.name}})</option>
                {% endfor %}
            </select>
            <input type="text" list="browsers" name="amount" value="" class="form-control contra-currency amount_currency_cls" autocomplete="off"><datalist id="browsers"><option value="No Max Limit"></datalist>
        </div>

        
    </div>
    <br>
    <div class="row contractfile_row">

        <div class="col-6">
            <strong class="big-text">
            Upload Contract File
            </strong class="big-text">
        </div>
        <div class="col-6 ">
            <table class="che-table"><tbody><tr><td><input type="file" accept="image, .png, .jpeg, .pdf, .jpg" name="con_file" class="con_file_cls form-control"></td> <td class="ms-3 in-btn-wid che-smline wid-but justify-content-between "><button id="add_file" class="btn btn-clr add-btn" type="button" value="add"><i class="fa fa-add"></i></button> <button id="remove_file" class="btn btn-clr del-btn" type="button" value="minus"><i class="fa fa-minus"></i></button></td> </tr></tbody></table>
        </div>

        
    </div>
<br>

    <div class="row">

        <div class="col-6">
            <strong class="big-text">
            Upload Price Table
            </strong class="big-text">
        </div>
        <div class="col-6">
            <table class="che-table"><tbody><tr><td><input type="file" accept="image, .png, .jpeg, .pdf, .jpg" name="price_file" class="con_price_file_cls form-control"></td> <td class="ms-3 in-btn-wid che-smline wid-but justify-content-between"><button id="add_file" class="btn btn-clr add-btn" type="button" value="add"><i class="fa fa-add"></i></button> <button id="remove_file" class="btn btn-clr del-btn" type="button" value="minus"><i class="fa fa-minus"></i></button></td> </tr></tbody></table>
        </div>

        
    </div>
</div>
     
    </div>
        <div class="text-center btn-cls">
            <input type="hidden" name="contract_date" id="contract_date_input" value="{{ contract_date }}">
            <input type="hidden" name="submit_type" class="submit_type" value=0>
            <button type="submit" class="btn btn-clr text-left draft-cls">Save as Draft</button>
            <button type="submit" class="btn btn-clr text-left final-cls">Submit</button>
        </div>
    </form>
</div>
</div>

{% endblock %}

{% block scripts %}
{{ block.super }}

<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.1/jquery.min.js" ></script>
<script src="https://ajax.googleapis.com/ajax/libs/jqueryui/1.12.1/jquery-ui.min.js" ></script>
    <script>
        var hdn_dateformat=$('#companydateformat').val()
        var csrf_token = "{{ csrf_token }}"

        $(document).ready(function(){
            $('.projectcls').each(function(){
                var find_inactive=$(this).find('option:selected').attr('data-id')
                if(find_inactive == 'False'){
                    $(this).closest('tr').find('#name_service,.projectcls,.p_discipline_cls,#disciplinetype_id,#ref_num,.dateformat-cls,.maximum-cls,#amount_currency,.supplydateformat-cls').attr('readonly','readonly')
                    $(this).closest('tr').find('.wcc_flow_cls,.con_file_cls,.con_price_file_cls').attr('disabled',true)
                }
            })

            $('.contracttablecls > tbody  > tr').each(function(index, tr) { 
                var projectid=$(tr).find('.projectcls').find(':selected').val()
                if (projectid != ''){
                    var currentelement=$(tr).find('.projectcls')
                    var distype=$(tr).find('td:eq(4)')
                    // if (typeof(projectid) != 'undefined'){
                        $.ajax({
                            type:"GET",
                            url:'/projects/companyprojectdevelopment',
                            data:{'projectid':projectid},
                            async: false,
                            success: function(data){
                                if (data.data != 'none'){
                                    var html=''
                                    html +='<option value="">--Select--</option>'
                                    $.each(data.data,function(key,val){
                                        html +='<option value='+val.id+'>'+val.fieldname+'</option>'
                                    })
                                    $(tr).find('.p_discipline_cls').html(html)
                                    // currentelement.next('td').find('.p_discipline_cls').html(html)

                                }
 
                            }
                        })
                        console.log($(tr).find('.hdnp_dis'))
                        var hdn_projectdiscipline=$(tr).find('.hdnp_dis').val()
                        if (hdn_projectdiscipline != ''){
                            $(tr).find('.p_discipline_cls option[value='+hdn_projectdiscipline+']').attr("selected", "selected");
                            $.ajax({
                                type:"GET",
                                url:'/projects/companyprojectdevelopment',
                                data:{'projectdisciplineid':hdn_projectdiscipline},
                                async: false,
                                success: function(data){
                                    if (data.data != 'none'){
                                        var html=''
                                        html +='<option value="">--Select--</option>'
                                        $.each(data.data,function(key,val){
                                            html +='<option value='+val.value+'>'+val.text+'</option>'
                                        })
                                        
                                        $('#disciplinetype_id').html(html)
                                    }
                                }
                                })
                                var hdn_projectdisciplinetype=$(tr).find('.hdnp_distype').val()

                                $('#disciplinetype_id option[value='+hdn_projectdisciplinetype+']').attr("selected", "selected");
                        }
                    // }
                }
            })
            
        })


        var optiondict={}
        var list=[]
        $("#id_companycurrenices option").each(function(){
            var thisOptionValue=$(this).val();
            var thistext=$(this).text()
            optiondict={"id":thisOptionValue,"symbol":thistext}
    
            list.push(optiondict)
        });

        
    var projectlist=[]
    var projectoptiondict={}
    $("#id_projects option").each(function(){
        var thisOptionValue=$(this).val();
        var status_check=$(this).attr('data-id')
        var thistext=$(this).text()
        projectoptiondict={"id":thisOptionValue,"projectname":thistext,'check_status':status_check}
        console.log('projectoptiondict',projectoptiondict)
        projectlist.push(projectoptiondict)
    });


    $(document).on('change','.projectcls',function(){
        var val=$(this).val()
        var get_role=$('#user_role').val()
        const find_text=$(this).find('option:selected').text()
        var get_text=$(this).find('option:selected').text()
        var check_status=$(this).find('option:selected').attr('data-id')
        if(check_status == 'False'){
            if (get_role == 2){
                swal.fire(''+find_text+' Inactive.')
            }
            if (get_role == 3){
            swal.fire(''+find_text+' Inactive. Please contact Client Admin')
            }
            $(this).val('')  
        }
        $(this).closest('tr').find('#disciplinetype_id').html('<option value="">--Select--</option>')
        var currentelement=$(this)
        if ( currentelement == ''){
            $(this).closest('td').next('td').find('.p_discipline_cls').html('<option value="">--Select--</option>')
        }
        else{
            $.ajax({
                type:"GET",
                url:'/projects/companyprojectdevelopment',
                data:{'projectid':val},
                success: function(data){
                    console.log(data)
                    var html=''
                    html +='<option value="">--Select--</option>'
                    $.each(data.data,function(key,val){
                        html +='<option value='+val.id+'>'+val.fieldname+'</option>'
                    })
                    currentelement.closest('td').next('td').find('.p_discipline_cls').html(html)
                }
            })
        }

    })

    $(document).on('change','.p_discipline_cls',function(){
        var val=$(this).val()
        var sername=$(this).attr('sername')
        
        var currentelement=$(this)
        if (val == ''){
            $(this).closest('td').next('td').find('#disciplinetype_id').html('<option value="">--Select--</option>')
        }
        else{
            $.ajax({
                type:"GET",
                url:'/projects/companyprojectdevelopment',
                data:{'projectdisciplineid':val},
                success: function(data){
                    console.log(data)
                    var html=''
                    html +='<option value="">--Select--</option>'
                    $.each(data.data,function(key,val){
                        html +='<option value='+val.value+'>'+val.text+'</option>'
                    })
                    
                currentelement.closest('td').next('td').find('#disciplinetype_id').html(html)
                }
            })
        }

    })

        $(document).on('click','.service-input',function(){
            var val=$(this).val()
            var vendor_id=$('#vendor_id').val()
            var currentelement=$(this)
            var tableshow=""
            if ($(this).is(':checked')){
    
                tableshow+='<div class="ser-vice-scroll"><table id="'+val+'table" class="contracttablecls ser-vice-wid">'
                if (val == 'service'){
                    tableshow+='<thead><tr id="content-head" ><th></th><th>WCC <i class="fa fa-info-circle" title="Work Completion Certificate Submission Required"></i></th><th>Name of Service</th><th>Project</th><th>Project Discipline</th><th>Discipline Type</th><th>SO Reference Number</th><th>Executed Date</th><th>Maximum Value of SO</ th><th>Upload Contract</th><th>Upload Price Table</th></tr></thead>'
                    tableshow+='<tbody><tr class="vend-service-top"><input type="hidden" name="'+val+'contracthdnid" value=""><td class="btn-line-same"> <button id="service-add" data-id='+val+' class="out-btn add-contra-btn" type="button" value="Add"> <i class="fa fa-plus"></i> </button> <button id="service-delete" class="out-btn minu-contra-btn delete-btn check-contract" data_id="" contract_type="original" type="button" value="'+val+'"> <i class="fa fa-minus"></i></button> </td> <td class="ser-wid text-center"><input type="checkbox" class="wcc-cbx wcc_flow_cls" name="'+val+'wcc" value="1"> <input type="hidden" value="0" name="'+val+'wcc"></td> <td ><textarea rows="3" cols="30" id="name_service" name="'+val+'n_service" placeholder="Name of Service" class="form-control"></textarea></td> <td class="prj-wid"><select name="'+val+'project" class="form-control projectcls"></select></td> <td class="width-increase prj-wid"><select id="project_discipline" name="'+val+'project_discipline" sername='+val+' class="form-control p_discipline_cls"><option value="">--Select--</option> </select></td>  <td class="width-increase prj-wid"><select name="'+val+'disciplinetype" id="disciplinetype_id" class="form-control"><option value="">--Select--</option></select></td> <td><textarea rows="3" cols="30" id="ref_num" name="'+val+'ref_number" placeholder="SO Reference Number" class="form-control refcls"></textarea></td> <td><input type="text" name="'+val+'execute_date"  autocomplete="off" class="dateformat-cls form-control" inv_count="" ></td> <td class="maxi-width"><select id="maximum_value" name="'+val+'currency" class="maximum-cls form-control"></select> <input list="browsers" type="text" id="amount_currency" name="'+val+'amount" class="amount_currency_cls form-control contra-currency" autocomplete="off"><datalist id="browsers"><option value="No Max Limit"></datalist> </td> <td><input type="file"  accept="image, .png, .jpeg, .pdf, .jpg" id="c_file" name="'+val+'contract_file0" class="con_file_cls"></td> <td><input type="file" accept="image, .png, .jpeg, .pdf, .jpg" id="price_file" name="'+val+'contract_price_file0" class="con_price_file_cls"></td></tr><tr class="sample"><td colspan="2" class="add-ment"><button id="amendment-add" data-id='+val+'  class="btn btn-clr add-btn-adda amendmentmaincls" type="button" serval="0" value="extrafiles">Amendment/Addendum</button></td></tr> <tr class="verti-td-same"> <td colspan="10"></td> </tr></tbody>'
                    tableshow+='</table></div>'
                }
                else if (val == 'supply'){
                    tableshow+='<thead><tr id="content-head" ><th></th><th>WCC <i class="fa fa-info-circle" title="Work Completion Certificate Submission Required"></i></th><th>Name of Supply</th><th>Project</th><th>Project Discipline</th><th>Discipline Type</th><th>SO Reference Number</th><th>Executed Date</th><th>Maximum Value of So</ th><th>Upload Contract</th><th>Upload Price Table</th></tr></thead>'
                    tableshow+='<tbody><tr class="vend-service-top"><input type="hidden" name="'+val+'contracthdnid" value=""><td class="btn-line-same"> <button id="service-add" data-id='+val+' class="out-btn add-contra-btn" type="button" value="Add"> <i class="fa fa-plus"></i> </button> <button id="service-delete" class="out-btn minu-contra-btn delete-btn check-contract" data_id="" contract_type="original" type="button" value="'+val+'"> <i class="fa fa-minus"></i></button> </td> <td class="ser-wid text-center"><input type="checkbox" class="wcc-cbx wcc_flow_cls" name="'+val+'wcc" value="1"> <input type="hidden" value="0" name="'+val+'wcc"></td> <td><textarea rows="3" cols="30" id="name_service" name="'+val+'n_service" placeholder="Name of Service" class="form-control"></textarea></td> <td class="prj-wid"><select name="'+val+'project" class="form-control projectcls"></select></td> <td class="width-increase prj-wid"><select id="project_discipline" name="'+val+'project_discipline" sername='+val+' class="form-control p_discipline_cls"><option value="">--Select--</option> </select></td>  <td class="width-increase prj-wid"><select name="'+val+'disciplinetype" id="disciplinetype_id" class="form-control"><option value="">--Select--</option></select></td> <td><textarea rows="3" cols="30" id="ref_num" name="'+val+'ref_number" class="form-control refcls" placeholder=SO Reference Number"></textarea></td> <td><input type="text" name="'+val+'execute_date"  autocomplete="off" class="supplydateformat-cls form-control" inv_count="" ></td> <td class="maxi-width"><select id="maximum_value" name="'+val+'currency" class="maximum-cls form-control"></select><input type="text" list="browsers" id="amount_currency" name="'+val+'amount" class="amount_currency_cls form-control contra-currency" autocomplete="off"><datalist id="browsers"><option value="No Max Limit"></datalist> </td> <td><input type="file" accept="image, .png, .jpeg, .pdf, .jpg" id="c_file" name="'+val+'contract_file0" class="con_file_cls"></td> <td><input type="file" accept="image, .png, .jpeg, .pdf, .jpg" id="price_file" name="'+val+'contract_price_file0" class="con_price_file_cls"></td></tr><tr class="sample"><td colspan="2" class="add-ment"> <button id="amendment-add" data-id='+val+' tableval="0" class="btn btn-clr add-btn-adda amendmentmaincls" type="button" serval="0" value="extrafiles">Amendment/Addendum</button> </td></tr> <tr class="verti-td-same"> <td colspan="10"></td> </tr> </tbody>'
                    tableshow+='</table>'
                }
                
                else{
                    tableshow+='<thead><tr id="content-head" ><th></th><th>WCC <i class="fa fa-info-circle" title="Work Completion Certificate Submission Required"></i></th><th>Name of Contract</th><th>Project</th><th>Project Discipline</th><th>Discipline Type</th><th>Contract Reference Number</th><th>Executed Date</th><th>Maximum Value of Contract</ th><th>Upload Contract</th><th>Upload Price Table</th></tr></thead>'
                    tableshow+='<tbody> <tr class="vend-service-top"><td class="btn-line-same"> <input type="hidden" name="'+val+'contracthdnid" value=""><button id="service-add" data-id='+val+' class="out-btn add-contra-btn" type="button" value="Add"> <i class="fa fa-plus"></i> </button> <button id="service-delete" class="out-btn minu-contra-btn" delete-"btn check-contract" data_id="" contract_type="original" type="button" value="'+val+'"> <i class="fa fa-minus"></i></button> </td> <td class="ser-wid text-center"><input type="checkbox" class="wcc-cbx wcc_flow_cls" name="'+val+'wcc" value="1"> <input type="hidden" value="0" name="'+val+'wcc"></td> <td><textarea rows="3" cols="30" id="name_service" name="'+val+'n_service" placeholder="Name of Service" class="form-control"></textarea></td><td class="prj-wid"><select name="'+val+'project" class="form-control projectcls"></select> <td class="width-increase prj-wid"><select id="project_discipline" name="'+val+'project_discipline" sername='+val+' class="form-control p_discipline_cls"><option value="">--Select--</option>  </select></td>  <td class="width-increase prj-wid"><select name="'+val+'disciplinetype" id="disciplinetype_id" class="form-control"><option value="">--Select--</option></select></td> <td><textarea rows="3" cols="30" id="ref_num" name="'+val+'ref_number" class="form-control refcls" placeholder="Contract Reference Number"></textarea></td> <td><input type="text" name="'+val+'execute_date"  autocomplete="off" class="sersuppdateformat-cls form-control" inv_count="" ></td>  <td class="maxi-width"><select id="maximum_value" name="'+val+'currency" class="maximum-cls form-control"></select><input list="browsers" type="text" id="amount_currency" name="'+val+'amount" class="amount_currency_cls form-control contra-currency" autocomplete="off"> <datalist id="browsers"><option value="No Max Limit"></datalist> </td> <td><input type="file" accept="image, .png, .jpeg, .pdf, .jpg" id="c_file" name="'+val+'contract_file0" class="con_file_cls"></td> <td><input type="file"  accept="image, .png, .jpeg, .pdf, .jpg" id="price_file" name="'+val+'contract_price_file0" class="con_price_file_cls"></td></tr><tr class="sample"><td colspan="2" class="add-ment"> <button id="amendment-add" data-id='+val+' tableval="0" class="btn btn-clr add-btn-adda amendmentmaincls" type="button" serval="0" value="extrafiles">Amendment/Addendum</button> </td></tr> <tr class="verti-td-same"> <td colspan="10"></td> </tr></tbody>'
                    tableshow+='</table>'
    
                }
                var selectoption='<option value="" selected>--Select--</option>'
    
                $.each(list,function(key,value){
                    selectoption+='<option value='+value.id+'>'+value.symbol+'</option>'
                })
                var projectoption='<option value="" selected>--Select--</option>'

                $.each(projectlist,function(key,value){
                    projectoption+='<option value='+value.id+' data-id='+value.check_status+'>'+value.projectname+'</option>'
                })
                console.log(selectoption)
                // alert(selectoption)
                $(this).parent().after(tableshow)
                $(this).closest('div').next('div').find('table').find('.projectcls').html(projectoption)
                $(this).closest('div').next('div').find('table').find('.maximum-cls').html(selectoption)
    
            }
            else{
                $.ajax({
                type:"GET",
                url:'/projects/vendorcontractcheck',
                data:{'vendor_id':vendor_id,'type':val},
                success: function(data){
                    console.log(data)
                    if (data.data == 'exsists'){
                        swal.fire('Unable to remove, Since there is already data associated with this Contract')
                        currentelement.prop( "checked", true );
                    }
                    else{
                        $('#'+val+'table').remove()
                    }
                }
                })
                
            }
        })
        function parseDynamicDateFormat(dateString) {
            // Your logic to parse the dynamic date format here
            // Example: Assuming dateString format: "Oct. 29, 2022, midnight"
            // You need to parse this format and convert it into a JavaScript Date object
            // Example parsing logic:
            var parsedDate = new Date(dateString);
            return parsedDate;

        }

        var dateString = $('#contract_date_input').val();
        var formattedDate = moment.utc(dateString).format('YYYY-MM-DD');
        var date = new Date(formattedDate);
        var cdate = date.getDate();
        var cmonth = date.getMonth() ;
        var cyear = date.getFullYear();

        var minDateStr = "{{ contractmaster.executed_date|checktime:request.user.company.id|convert_date_format }}"; 
        if (hdn_dateformat ==''){
            $(document).on('focus',".dateformat-cls", function(){
                var inv_count=$(this).attr('inv_count')
                if (inv_count != "1"){
                    $(this).datepicker({
                        dateFormat: 'dd-M-yy',
                        minDate: new Date(cyear,cmonth,cdate),
                        //minDate: parseDynamicDateFormat(minDateStr),
                        maxDate:new Date(),
                        yearRange: '1900:+0',
                        changeMonth:true,
                        changeYear:true,
                    });
                }
              });
        }
        else{
            $(document).on('focus',".dateformat-cls", function(){
                console.log('dfrg')
                var inv_count=$(this).attr('inv_count')
                if (inv_count != "1"){
                    $(this).datepicker({
                        dateFormat: hdn_dateformat,
                        //minDate: parseDynamicDateFormat(minDateStr),
                        minDate: new Date(cyear,cmonth,cdate),
                        maxDate:new Date(),
                        yearRange: '1900:+0',
                        changeMonth:true,
                        changeYear:true,
                    });
                }
              });
        }

        if (hdn_dateformat ==''){
            $(document).on('focus','.supplydateformat-cls',function(){
                var inv_count=$(this).attr('inv_count')
                if (inv_count != "1"){
                    $(this).datepicker({
                        dateFormat: 'dd-M-yy',
                        maxDate:new Date(),
                        yearRange: '1900:+0',
                        changeMonth:true,
                        changeYear:true,
                    });
                }
              });
        }
        else{
            $(document).on('focus','.supplydateformat-cls',function(){
                console.log('2')
                var inv_count=$(this).attr('inv_count')
                if (inv_count != "1"){
                    $(this).datepicker({
                        dateFormat: hdn_dateformat,
                        maxDate:new Date(),
                        yearRange: '1900:+0',
                        changeMonth:true,
                        changeYear:true,
                    });
                }
              });
        }
    
    
        if (hdn_dateformat ==''){
            $(document).on('focus','.sersuppdateformat-cls',function(){
                var inv_count=$(this).attr('inv_count')
                if (inv_count != "1"){
                    $(this).datepicker({
                        dateFormat: 'dd-M-yy',
                        maxDate:new Date(),
                        yearRange: '1900:+0',
                        changeMonth:true,
                        changeYear:true,
                    });
                }
              });
        }
        else{
            $(document).on('focus','.sersuppdateformat-cls',function(){
                var inv_count=$(this).attr('inv_count')
                if (inv_count != "1"){
                    $(this).datepicker({
                        dateFormat: hdn_dateformat,
                        maxDate:new Date(),
                        yearRange: '1900:+0',
                        changeMonth:true,
                        changeYear:true,
                    });
                }
              });
        }

        $(document).on('change','.p_discipline_cls',function(){
            var sername=$(this).attr('sername')
            html='<select name="'+sername+'disciplinetype" class="form-control">'
            html+='<option value="">--Select--</option>'
            html+='<option value="subsurface_and_reservoir_engineering">Subsurface and Reservoir Engineering</option><option value="drilling_and_completions">Drilling and Completions</option><option value="facilities_and_projects">Facilities and Projects</option><option value="production_and_operations">Production and Operations</option><option value="human_resources_and_administration">Human Resources and Administration</option><option value="legal">Legal</option><option value="ICT">ICT</option><option value="finance">Finance</option><option value="QHSE_&_community_development">QHSE & Community Development</option><option value="business_development_&_sales_and_marketing">Business Development & Sales and Marketing</option><option value="insurance">Insurance</option><option value="miscellaneous">Miscellaneous</option>' 
            html+='</select>'
            $(this).closest('td').next('td').find('#disciplinetype_id').html(html)
        })

        



        $(document).on('click','#extrafile-delete',function(){
            var tableid=$(this).closest('table').attr('id')
            var service=$(this).attr('service')
            var servicecount=$(this).attr('servicecount')
            var contract_type=$(this).attr('contract_type')
            var data_id=$(this).attr('data_id')
            var invoice_check=checkcontract(contract_type,data_id)
            if (invoice_check == true){
                swal.fire('Unable to remove, Since there is already data associated with this Contract')
            }
            else{
                var tablelen=$('#'+tableid+' tbody tr').length
                if (tablelen >1){
                    $(this).closest('tr').remove()
                    var count=0
                    $('#'+tableid+' > tbody  > tr').each(function(index, tr) { 
                        $(this).find('td:eq(0)').find('select').attr('name',''+service+'extrafile'+servicecount+count+'')
                        $(this).find('td:eq(1)').find('textarea').attr('name',''+service+'ref_num'+servicecount+count+'')
                        $(this).find('td:eq(2)').find('input').attr('name',''+service+'dateformat'+servicecount+count+'')
                        $(this).find('td:eq(3)').find('select').attr('name',''+service+'currency'+servicecount+count+'')
                        $(this).find('td:eq(3)').find('input').attr('name',''+service+'amount'+servicecount+count+'')
                        $(this).find('td:eq(4)').find('input').attr('name',''+service+'con_file'+servicecount+count+'')
                        $(this).find('td:eq(5)').find('input').attr('name',''+service+'price_file'+servicecount+count+'')
                        count ++;
                    });
                }
                else{
                    $(this).closest('table').remove()
                }
            }
        })


        var row=1
        $(document).on('click','#service-add',function(){
            var val=$(this).attr('data-id')
            var servals=$('#'+val+'table').find('tr.sample').last().find('td > button').attr('serval')
            console.log(servals)
            var serval=parseInt(servals)+1
            //var indexvalue=$('#'+val+'table tr:last').index()+1
            var indexvalue=$(this).closest('tr').index()+1
            var tableshow=''
            if (val == 'service'){
                tableshow+='<tr class="vend-service-top"><input type="hidden" name="'+val+'contracthdnid" value=""><td class="btn-line-same"> <button id="service-add" data-id='+val+' class="out-btn add-contra-btn" type="button" value="Add"> <i class="fa fa-plus"></i> </button> <button id="service-delete" class=" out-btn delete-btn check-contract" data_id=""  contract_type="original" type="button" value="'+val+'"> <i class="fa fa-minus"></i></button> </td> <td class="text-center"><input type="checkbox" class="wcc-cbx wcc_flow_cls" name="'+val+'wcc" value="1"> <input type="hidden" value="0" name="'+val+'wcc"></td> <td><textarea rows="3" cols="30" id="name_service" placeholder="Name of service" name="'+val+'n_service" class="form-control"></textarea></td> <td><select name="'+val+'project" class="form-control projectcls"><option value="">--Select--</option></select></td> <td><select name="'+val+'project_discipline" id="project_discipline" sername='+val+' class="form-control p_discipline_cls"><option value="">--Select--</option></select></td>  <td><select name="'+val+'disciplinetype" id="disciplinetype_id" class="form-control"><option value="">--Select--</option></select></td> <td><textarea rows="3" cols="30" id="ref_num" name="'+val+'ref_number" placeholder="SO Reference Number" class="form-control refcls"></textarea></td> <td><input type="text" name="'+val+'execute_date"  autocomplete="off" class="dateformat-cls form-control" inv_count="" ></td> <td class="maxi-width"><select id="maximum_value" name="'+val+'currency" class="maximum-cls form-control"</select><input type="text" id="amount_currency" name="'+val+'amount" list="browsers" autocomplete="off" class="amount_currency_cls form-control contra-currency"><datalist id="browsers"><option value="No Max Limit"></datalist> </td> <td><input type="file" accept="image, .png, .jpeg, .pdf, .jpg" id="c_file" name="'+val+'contract_file'+serval+'" class="con_file_cls"></td> <td><input type="file" accept="image, .png, .jpeg, .pdf, .jpg" id="price_file" name="'+val+'contract_price_file'+serval+'" class="con_price_file_cls"></td></tr><tr class="sample"> <td colspan="2" class="add-ment"> <button id="amendment-add" data-id='+val+' tableval="0" class="btn btn-clr add-btn-supply amendmentmaincls" type="button" serval="'+serval+'" value="extrafiles">Amendment/Addendum</button> </td> </tr> <tr class="verti-td-same"><td colspan="10"></td></tr>'
            }

            else if (val == 'supply'){
                tableshow+='<tr class="vend-service-top"><input type="hidden" name="'+val+'contracthdnid" value=""><td  class="btn-line-same"> <button id="service-add" data-id='+val+' class="out-btn add-contra-btn" type="button" value="Add"> <i class="fa fa-plus"></i> </button> <button id="service-delete" class=" out-btn delete-btn check-contract" data_id=""  contract_type="original" type="button" value="'+val+'"> <i class="fa fa-minus"></i></button> </td> <td class="text-center"><input type="checkbox" class="wcc-cbx wcc_flow_cls" name="'+val+'wcc" value="1"> <input type="hidden" value="0" name="'+val+'wcc"></td> <td><textarea rows="3" cols="30" id="name_service" placeholder="Name of service" name="'+val+'n_service" class="form-control"></textarea></td> <td><select name="'+val+'project" class="form-control projectcls"><option value="">--Select--</option></select></td> <td><select id="project_discipline" name="'+val+'project_discipline" sername='+val+' class="form-control p_discipline_cls"><option value="">--Select--</option> </select></td>  <td><select name="'+val+'disciplinetype" id="disciplinetype_id" class="form-control"><option value="">--Select--</option></select></td> <td><textarea rows="3" cols="30" id="ref_num" name="'+val+'ref_number" placeholder="SO Reference Number" class="form-control refcls"></textarea></td> <td><input type="text" name="'+val+'execute_date"  autocomplete="off" class="supplydateformat-cls form-control" inv_count="" ></td> <td class="maxi-width"><select id="maximum_value" name="'+val+'currency" class="maximum-cls form-control"</select><input type="text" id="amount_currency" name="'+val+'amount" list="browsers" autocomplete="off" class="amount_currency_cls form-control contra-currency"><datalist id="browsers"><option value="No Max Limit"></datalist> </td> <td><input type="file"  accept="image, .png, .jpeg, .pdf, .jpg" id="c_file" name="'+val+'contract_file'+serval+'" class="con_file_cls"></td> <td><input type="file" accept="image, .png, .jpeg, .pdf, .jpg" id="price_file" name="'+val+'contract_price_file'+serval+'" class="con_price_file_cls"></td></tr><tr class="sample"> <td colspan="2" class="add-ment"> <button id="amendment-add" data-id='+val+' tableval="0" class="btn btn-clr add-btn-supply amendmentmaincls" type="button" serval="'+serval+'" value="extrafiles">Amendment/Addendum</button> </td> </tr> <tr class="verti-td-same"><td colspan="10"></td></tr>'



            }
            else{
                tableshow+='<tr class="vend-service-top"><input type="hidden" name="'+val+'contracthdnid" value=""><td class="btn-line-same"> <button id="service-add" data-id='+val+' class="out-btn add-contra-btn" type="button" value="Add"> <i class="fa fa-plus"></i> </button> <button id="service-delete" class=" out-btn delete-btn check-contract" data_id=""  contract_type="original" type="button" value="'+val+'"> <i class="fa fa-minus"></i></button> </td> <td class="text-center"><input type="checkbox" class="wcc-cbx wcc_flow_cls" name="'+val+'wcc" value="1"> <input type="hidden" value="0" name="'+val+'wcc"></td> <td><textarea rows="3" cols="30" id="name_service" placeholder="Name of service" name="'+val+'n_service" class="form-control"></textarea></td> <td><select name="'+val+'project" class="form-control projectcls"><option value="">--Select--</option></select></td> <td><select id="project_discipline" name="'+val+'project_discipline" sername='+val+' class="form-control p_discipline_cls"><option value="">--Select--</option></select></td>  <td><select name="'+val+'disciplinetype" id="disciplinetype_id" class="form-control"><option value="">--Select--</option></select></td> <td><textarea rows="3" cols="30" id="ref_num" name="'+val+'ref_number" placeholder="Contract Reference Number" class="form-control refcls"></textarea></td> <td><input type="text" name="'+val+'execute_date"  autocomplete="off" class="sersuppdateformat-cls form-control" inv_count=""></td> <td class="maxi-width"><select id="maximum_value" name="'+val+'currency" class="maximum-cls form-control"</select><input type="text" id="amount_currency" name="'+val+'amount" list="browsers" autocomplete="off" class="amount_currency_cls form-control contra-currency"><datalist id="browsers"><option value="No Max Limit"></datalist> </td> <td><input type="file" id="c_file" name="'+val+'contract_file'+serval+'" class="con_file_cls"></td> <td><input type="file" accept="image, .png, .jpeg, .pdf, .jpg" id="price_file" name="'+val+'contract_price_file'+serval+'" class="con_price_file_cls"></td> </tr><tr class="sample"> <td colspan="2" class="add-ment"> <button id="amendment-add" data-id='+val+' tableval="0" class="btn btn-clr add-btn-supply amendmentmaincls" type="button" serval="'+serval+'" value="extrafiles">Amendment/Addendum</button> </td> </tr> <tr class="verti-td-same"><td colspan="10"></td></tr>'
            }
            var selectoption='<option value="" selected>--Select--</option>'
            $.each(list,function(key,value){
                selectoption+='<option value='+value.id+'>'+value.symbol+'</option>'
            })
            $('#'+val+'table').append(tableshow)

            var projectoption='<option value="" selected>--Select--</option>'

            $.each(projectlist,function(key,value){
                projectoption+='<option value='+value.id+' data-id='+value.check_status+'>'+value.projectname+'</option>'
            })
            $(this).closest('table').find('tr:last').prev('tr').prev('tr').find('.projectcls').html(projectoption)
            //$(this).closest('tr').next('tr').next('tr').next('tr').find('.projectcls').html(projectoption)
            $(this).closest('table').find('tr:last').prev('tr').prev('tr').find('.maximum-cls').html(selectoption)
            //$(this).closest('tr').next('tr').next('tr').next('tr').find('.maximum-cls').html(selectoption)
            //$('.maximum-cls').html(selectoption)
        })

        $(document).on('click','#service-delete',function(){
            var value=$(this).val();
            var contract_type=$(this).attr('contract_type')
            var data_id=$(this).attr('data_id')
            var invoice_check=checkcontract(contract_type,data_id)
            if (invoice_check == true){
                swal.fire('Unable to remove, Since there is already data associated with this Contract')
            }
            else{
                if ($('#'+value+'table tbody tr').length > 4 || $('#'+value+'table tbody tr').length > 3){
                    $(this).closest('tr').next('tr').next('tr').remove();
                    $(this).closest('tr').next('tr').remove();
                    $(this).closest('tr').remove();
                    
                    var changevalue=''
                    if (value == 'service_supply'){
                        changevalue='servicesupply'
                    }
                    else{
                        changevalue=value
                    }
                    var count=0
                    var pricecount=0
                    var servalcount=0
                    var hdninputcount=0
                    var outsideloopcount=0
                    var settableid=value+'table'
                    // alert(settableid)
                    $('#'+settableid+' > tbody > tr').each(function(index, tr) {
                    
                        //tr.find('.vend-service-top').find('td:eq(8)').find('input').attr('name',''+changevalue+'contract_file'+count)
                        //tr.find('.vend-service-top').find('td:eq(9)').find('input').attr('name',''+changevalue+'_price_file'+count)
                        //tr.find('.sample td > button').attr('serval',count)
                        
                        var contractfile=$(this).find('td:eq(8)').find('.con_file_cls')
                        if (contractfile.hasClass('con_file_cls')){
                            contractfile.attr('name',''+changevalue+'contract_file'+count)
                            count ++;
                        }

                        var pricetable=$(this).find('td:eq(9)').find('.con_price_file_cls')
                        if (pricetable.hasClass('con_price_file_cls')){
                            pricetable.attr('name',''+changevalue+'_price_file'+pricecount)
                            pricecount ++;
                        }
                        var changeserval=$(this).find('td:eq(0)').find('.amendmentmaincls')
                        if (changeserval.hasClass('amendmentmaincls')){
                            changeserval.attr('serval',servalcount)
                            servalcount ++;
                        }
                        var gettable=$(this).find('td:eq(0)').find('.amendmenttablecls')
                        if (gettable.hasClass('amendmenttablecls')){
                            var amendmenttableid=gettable.attr('id')
                            var insidetablecount=0
                            $('#'+amendmenttableid+' tbody tr').each(function(index, tr) {
                                var a=$(this).find('td:eq(0)').find('input').attr('name',''+changevalue+hdninputcount+'')
                                $(this).find('td:eq(0)').find('select').attr('name',''+changevalue+'extrafile'+outsideloopcount+insidetablecount+'')
                                $(this).find('td:eq(1)').find('textarea').attr('name',''+changevalue+'ref_num'+outsideloopcount+insidetablecount+'')
                                $(this).find('td:eq(2)').find('input').attr('name',''+changevalue+'dateformat'+outsideloopcount+insidetablecount+'')
                                $(this).find('td:eq(3)').find('select').attr('name',''+changevalue+'currency'+outsideloopcount+insidetablecount+'')
                                $(this).find('td:eq(3)').find('input').attr('name',''+changevalue+'amount'+outsideloopcount+insidetablecount+'')
                                $(this).find('td:eq(4)').find('input').attr('name',''+changevalue+'con_file'+outsideloopcount+insidetablecount+'')
                                $(this).find('td:eq(5)').find('input').attr('name',''+changevalue+'price_file'+outsideloopcount+insidetablecount+'')

                                insidetablecount ++;
                                hdninputcount ++;
                            })
                            outsideloopcount ++;
                        }
                        
                    }) 
                }
            }
        })







        $(document).on('change',".con_file_cls", function(){

            $(this).next('p').remove()
          });

          $(document).on('change',".con_price_file_cls", function(){

            $(this).next('p').remove()
          });


          function numberWithCommas(number) {

            var parts = number.toString().split(".");
    
            parts[0] = parts[0].replace(/\B(?=(\d{3})+(?!\d))/g, ",");
            console.log(parts)
            return parts.join(".");
        }
    

        $(document).on('click','#amendment-add',function(){
            var get_type=$(this).attr('check_availablity')
            console.log('get_type',get_type)
            var setindexval=$(this).attr('serval')
            var sevid=$(this).attr('sevid')
            var val=$(this).attr('data-id')
            var value=$(this).val()
            var trindex=$(this).closest('tr').index()
            var tableindex=$(this).closest('tr').next('tr').find('td').find('table').find('tr:last').index()+1
            var html=''
            //alert(tableindex)


            var amendmenttableindex=$(this).closest('tr').next('tr').find('td').find('table tr:last').index()+1
            var countids=$(this).closest('tr').next('tr').find('td').find('table tr:last').find('.count-cls').val()

            
            if ($(this).closest('tr').next('tr').find('td').find('table').length){
                    html+='<tr> <td class="text-center"><input type="checkbox" class="wcc-cbx amend_wcc_flow_cls" name="'+val+'wcc'+setindexval+'" value="1"> <input type="hidden" value="0" name="'+val+'wcc'+setindexval+'"></td>  <td class="edit-addme-wid"><input type="hidden" name="'+val+setindexval+'" value=""> <select name="'+val+'extrafile'+setindexval+tableindex+'" class="form-control"> <option value="">--Select--</option> <option value="Amendment">Amendment</option> <option value="Addendum">Addendum</option> </select></td> <td><textarea rows="3" cols="30" placeholder="Reference Number" name="'+val+'ref_num'+setindexval+tableindex+'" class="form-control refcls"></textarea></td> <td><input type="text" name="'+val+'dateformat'+setindexval+tableindex+'" autocomplete="off" class="dateformat-cls form-control" inv_count=""></td> <td><select id="maximum_value" name="'+val+'currency'+setindexval+tableindex+'" class="maximum-extra-cls form-control"></select><input type="text" list="browsers" id="amount_currency" name="'+val+'amount'+setindexval+tableindex+'" class="amount_currency_cls form-control contra-currency" autocomplete="off"> <datalist id="browsers"><option value="No Max Limit">/td> <td><input type="file" accept="image, .png, .jpeg, .pdf, .jpg" name="'+val+'con_file'+setindexval+tableindex+'" class="form-control"></td> <td><input type="file" accept="image, .png, .jpeg, .pdf, .jpg" name="'+val+'price_file'+setindexval+tableindex+'" class="form-control"></td> <td><button id="extrafile-delete" class="btn-clr btn minus-btn-add check-contract" type="button" data_id="" contract_type="amendment" service='+val+' servicecount='+setindexval+' value="delete"> <i class="fa fa-minus"></i></button></td></tr>'
                    if(get_type == 1){
                    $('#'+val+''+value+''+setindexval+'').append(html)
                    }
                    var selectoption='<option value="" selected>--Select--</option>'
                    $.each(list,function(key,value){
                        selectoption+='<option value='+value.id+'>'+value.symbol+'</option>'
                    })
                    if(get_type == 1){
                    $('#'+val+''+value+''+setindexval+' tr:last').find('.maximum-extra-cls').html(selectoption)
                    }
                    else{
                        swal.fire('Inactive Project')
                    }
            
            }
            else{
                    html='<table id="'+val+''+value+''+setindexval+'" class="amendmenttablecls">'

                    html +='<thead class="addmen-title"><tr><th>WCC <i class="fa fa-info-circle" title="Work Completion Certificate Submission Required"></i></th><th>Type</th><th>Reference Number</th><th>Executed Date</th><th>Maximum Value</th><th>Upload Contract</th><th>Upload Price Table</th></tr></thead>'
                    
                    html +='<tbody> <tr> <td class="text-center"><input type="checkbox" class="wcc-cbx amend_wcc_flow_cls" name="'+val+'wcc'+setindexval+'" value="1"> <input type="hidden" value="0" name="'+val+'wcc'+setindexval+'"></td>  <td class="edit-addme-wid"> <input type="hidden" name="'+val+setindexval+'" value=""> <select name="'+val+'extrafile'+setindexval+tableindex+'" class="form-control"> <option value="">--Select--</option> <option value="Amendment">Amendment</option> <option value="Addendum">Addendum</option> </select> </td> <td><textarea rows="3" cols="30" name="'+val+'ref_num'+setindexval+tableindex+'" class="form-control refcls"></textarea></td> <td><input type="text" name="'+val+'dateformat'+setindexval+tableindex+'" autocomplete="off" class="dateformat-cls form-control" inv_count=""></td> <td><select id="maximum_value" name="'+val+'currency'+setindexval+tableindex+'" class="maximum-extra-cls form-control"></select><input list="browsers" type="text" id="amount_currency" name="'+val+'amount'+setindexval+tableindex+'" class="amount_currency_cls form-control contra-currency" autocomplete="off"><datalist id="browsers"><option value="No Max Limit"></td> <td><input type="file" accept="image, .png, .jpeg, .pdf, .jpg" name="'+val+'con_file'+setindexval+tableindex+'" class="form-control"></td> <td><input type="file" accept="image, .png, .jpeg, .pdf, .jpg" name="'+val+'price_file'+setindexval+tableindex+'" class="form-control"></td> <td><button id="extrafile-delete" class="btn-clr btn minus-btn-add check-contract" data_id="" contract_type="amendment" type="button" service='+val+' servicecount='+setindexval+' value="delete"> <i class="fa fa-minus"></i></button></td></tr></tbody></table>'
                    if(get_type == 1){
                    $(this).closest('tr').next('tr').find('td').append(html)
                    }
                    var selectoption='<option value="" selected>--Select--</option>'
                    $.each(list,function(key,value){
                        selectoption+='<option value='+value.id+'>'+value.symbol+'</option>'
                    })
                    if(get_type == 1){
                    $('#'+val+''+value+''+setindexval+' tr:last').find('.maximum-extra-cls').html(selectoption)
                    }
                    else{
                        swal.fire('Inactive Project')
                    }
                }
        })



    

        $(document).on('change','.amount_currency_cls',function(){
            $(this).next('span').remove();
            var val=$(this).val()
            if (val != 'No Max Limit' && val!='no max limit')
                {
                $(this).val(val.replace(/([-€~!@#$%^&*()_+=`{}\[\]\|\\:;'<>A-Za-z])+/g, ''));
                }
            var number=$(this).val()
            if ( number !=''){
                if (number==0){
                    $(this).after('<span class="waring-err">Value cannot be Zero</span>')
                }
                else{
                    $(this).next('span').remove();
                }
            }
            else{
                $(this).next('span').remove();
            }
            $(".amount_currency_cls").each(function() {
                var num = $(this).val();
                var removecomma=num.replace(/,/g, '');
                var commaNum = numberWithCommas(decimal_value(removecomma));
                $(this).val(commaNum);
            });
            if($(this).val().indexOf('.')!=-1){         
                if($(this).val().split(".")[1].length > 2){                
                    if( isNaN( parseFloat( this.value ) ) ) return;
                    this.value = parseFloat(this.value).toFixed(2);
                    }  
                }            
            return this; //for chaining
        })


$(document).on('keyup','.refcls',function(){
    $(this).next('span').remove()
    var val=$(this).val().toLowerCase()
    if(val !='')
    {
        $(this).next('span').remove()
    
    var currentelement=$(this)
    $.ajax({
        type: "GET",
        url:'/projects/checkcontractrefduplicate',
        data: {'refnum':val},
        success: function(data)
        {
            if (data.data == 'exists'){
                currentelement.next('span').remove()
                currentelement.after('<span class="waring-err">Contract already exists in the contract master</span>')
            }
            else{
                currentelement.next('span').remove()
                var z=0;
                $(".refcls").each(function(key,value){
                    var y=$(value).val().toLowerCase();
                    if (val !='' && y !=''){
                        if(val==y){
                            z=z+1;
                        }
                }
                });
                
                if(z > 1){
                    // currentelement.addClass("error")
                    // currentelement.attr('data-error',0); 
                    currentelement.after('<span class="waring-err">Contract already exists</span>')
                }
                else{
                    currentelement.removeClass("error")
                    // currentelement.attr('data-error',1); 

                }   
            }
        }
    })
    }
    else{
        console.log('a')
        // $(this).after('<span class="waring-err">Enter SO Reference Number</span>')
    }
})

$(document).on('click','.final-cls',function(e){
    e.preventDefault()
    var count=0
    var checkedcount=0
    var form=$('#editcontractmaster')
    $('input.commoncls[type=checkbox]').not(':hidden').each(function(){
        if ($(this).is(':checked')){
            console.log('true')
            checkedcount ++;
        }
        else{
            // checkedcount ++;
            // console.log($(this))
            $(this).addClass('con_error')
        }
    })
    $('select').not(':hidden').each(function(){
        var val=$(this).find(':selected').val()
        
        if (val == ''){
            count ++;
           
            // console.log($(this))
            $(this).addClass('con_error')
            // console.log('a')
        }
    })
    $("input:text, textarea").not(':hidden').each(function(){
       
        var val=$(this).val()
        if (val == ''){
            count ++;
            // console.log($(this))
            $(this).addClass('con_error')
        }
       
    });

    $('.ref_num').not(':hidden').each(function(){
        var this_ref_num=$(this)
        var ref_num=$.trim($(this).val())
        reference_number(this_ref_num,ref_num)
        if($(this).hasClass('con_error')){
            count ++;
        }
    })

    $("input:file").not(':hidden').each(function(){
       
       var val=$(this).next('p')
       console.log('val',val.length)
    if (val.length ==  0 ){
        if ($(this).val() == ''){
            count ++;
            $(this).addClass('con_error')
        }
        }
       if (val == ''){
           count ++;
           $(this).addClass('con_error')
       }
      
   });
    // console.log(count)
    if (count == 0 && checkedcount >= 0){
        // alert('s')
        $('.submit_type').val(1)
        form.submit()
    }
})

$(document).on('change','.con_error',function(){
    $(this).removeClass('con_error')
    
})

var value;
function checkcontract(contract_type,contract_id){
    console.log('a',contract_type,contract_id)
    if (contract_id != ''){
        $.ajax({
            url: "/projects/checkcontractinvoice", 
            data:{'contract_type':contract_type,'contract_id':contract_id},
            async:false,
            success: function(data){
                console.log(data)
                if (data.data == 'exsists'){
                    value=true
                }
                else{
                    value=false
                }
            }
        });
        return value
    }
    else{
        value = false
        return value
    }
}

$(document).on('click','.wcc_flow_cls',function(){
    let get_project_id=$(this).closest('tr').find('.projectcls').find(':selected').val();
    let current_element=$(this);

    if (get_project_id){
        if ($(this).is(':checked')){
            $.ajax({
                type:"GET",
                url:'/projects/companyprojectdevelopment',
                data:{'projectid':get_project_id},
                success: function(data){
                    if (data.project_wcc_flow == 0){
                        swal.fire('WCC Flow not Added in this Project')
                        current_element.closest('tr').find('.wcc_flow_cls').prop('checked',false);
                        current_element.closest('tr').find('.wcc_flow_cls').val('1');
                        current_element.closest('td').find('input[type=hidden]').attr('disabled',false);
                    }
                    else{
                        current_element.closest('tr').find('.wcc_flow_cls').prop('checked',true);
                        current_element.closest('tr').find('.wcc_flow_cls').val('1');
                        current_element.closest('td').find('input[type=hidden]').attr('disabled',true);
                    }
                }
            })
        }
        else{
            $(this).closest('td').find('input[type=hidden]').attr('disabled',false);
            current_element.closest('tr').find('.wcc_flow_cls').val('0');
        }
    }
    else{
        swal.fire('Select Project and Then Select WCC');
        current_element.closest('tr').find('.wcc_flow_cls').prop('checked',false);
        current_element.closest('tr').find('.wcc_flow_cls').val('0');
        current_element.closest('td').find('input[type=hidden]').attr('disabled',false); 
    }
})


$(document).on('click','.amend_wcc_flow_cls',function(){
    let get_project_id=$('.projectcls').val();
    let current_element=$(this);
    console.log(get_project_id)
    if (get_project_id){
        if ($(this).is(':checked')){
            $.ajax({
                type:"GET",
                url:'/projects/companyprojectdevelopment',
                data:{'projectid':get_project_id},
                success: function(data){
                    if (data.project_wcc_flow == 0){
                        swal.fire('Wcc Flow not Added in this Project')
                        current_element.prop('checked',false);
                        current_element.val(0);
                        current_element.closest('td').find('input[type=hidden]').attr('disabled',false);
                    }
                    else{
                        current_element.val(1);
                        current_element.prop('checked',true);
                        current_element.closest('td').find('input[type=hidden]').attr('disabled',true);
                    }
                }
            })
        }
        else{
            current_element.val(0);
            $(this).closest('td').find('input[type=hidden]').attr('disabled',false);
        }
    }
   
})

$(document).on('click','.add-btn',function(){
    html=$(this).closest('tr').clone()
    html.find('.con_file_cls,.con_price_file_cls').val('')
    $(this).closest('tbody').append(html)
})

$(document).on('click','.del-btn',function(){
    let tr_length=$(this).closest('tbody').find('tr').length
    if (tr_length > 1){
    $(this).closest('tr').remove()
    }
})


$(document).on('keyup','.ref_num',function(){
    var this_ref_num=$(this)
    var ref_num=$.trim($(this).val())
    reference_number(this_ref_num,ref_num)
})

$(document).on('change','.ref_num',function(){
    var this_ref_num=$(this)
    var ref_num=$.trim($(this).val())
    reference_number(this_ref_num,ref_num)
})

function reference_number(this_ref_num,ref_num){
    $.ajax({
        type: "GET",
        headers: { "X-CSRFToken": csrf_token },
        url: "/projects/checkreferencenumber",
        data: {
            'ref_num':ref_num,
        }, 
        success: function(data){
            if(data.data == '1' || data.data == 1){
                this_ref_num.addClass('con_error')
            }
            else{
                this_ref_num.removeClass('con_error')
            }
          
        }
    });
}



$(document).on('click','.draft-cls',function(e){
    e.preventDefault()
    var count=0
    var form=$('#editcontractmaster')
    $('.ref_num').not(':hidden').each(function(){
        var this_ref_num=$(this)
        var ref_num=$.trim($(this).val())
        reference_number(this_ref_num,ref_num)
        if($(this).hasClass('con_error')){
            count ++;
        }
    })
    if (count == 0){
        $('.submit_type').val(0)
        form.submit()
    }
})

    </script>
{% endblock %}
